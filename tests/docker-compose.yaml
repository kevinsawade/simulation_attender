version: '3.7'

services:
  openldap:
    image: bitnami/openldap:latest
    container_name: openldap
    hostname: openldap.example.org
    domainname: example.org
    ports:
      - 389:389
      - 636:636
    environment:
      - LDAP_ADMIN_USERNAME=admin
      - LDAP_ADMIN_PASSWORD=adminpassword
      - LDAP_USERS=user01,user02
      - LDAP_PASSWORDS=password1,password2
      - LDAP_CONFIG_ADMIN_ENABLED=yes
      - LDAP_CONFIG_ADMIN_USERNAME=admin
      - LDAP_CONFIG_ADMIN_PASSWORD=configpassword
      - LDAP_ENABLE_TLS=yes
      - LDAP_PORT_NUMBER=389
      - LDAP_LDAPS_PORT_NUMBER=636
      - LDAP_TLS_CERT_FILE=/certs/server.crt
      - LDAP_TLS_KEY_FILE=/certs/server.key
      - LDAP_TLS_CA_FILE=/certs/ca.crt
    volumes:
      - "$PWD/certs:/certs"
      - "$PWD/openldap_data:/bitnami/openldap"
    networks:
      default:
        aliases:
          - openldap.example.org


  phpldapadmin:
    image: osixia/phpldapadmin:latest
    container_name: phpldapadmin
    domainname: example.org
    hostname: phpldapadmin
    ports:
      - 10080:80
      - 10443:443
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: "openldap"
      PHPLDAPADMIN_HTTPS: "true"
    depends_on:
      - openldap
    networks:
      default:
        aliases:
          - phpldapadmin.example.org
          

  client:
    image: kevisnawade/ldap-client
    container_name: client
    domainname: example.org
    hostname: client.example.org
    ports:
      - 222:22
    build:
      context: .
      dockerfile: ldap_client/Dockerfile
    environment:
      - LDAP_ADMIN_PASSWORD=adminpassword
    depends_on:
      - openldap
    networks:
      default:
        aliases:
          - client.example.org

  nfs:
    image: erichough/nfs-server:latest
    container_name: nfs-server
    domainname: example.org
    hostname: nfs.example.org
    privileged: true
    cap_add:
      - CAP_SYS_ADMIN
    ports:
      - 2049:2049
    environment:
      - SHARED_DIRECTORY=/data
    networks:
      default:
        aliases:
          - nfs.example.org
    volumes:
      - "./nfs_mount:/nfs"
      - "./nfs_server/exports:/etc/exports:ro"

  # client2:
  #   image: kevisnawade/ldap-client
  #   container_name: client2
  #   domainname: example.org
  #   hostname: client.example.org
  #   ports:
  #     - "223:22"
  #   build:
  #     context: .
  #     dockerfile: ldap_client/Dockerfile
  #   environment:
  #     - LDAP_ADMIN_PASSWORD=adminpassword
  #   depends_on:
  #     - openldap
  #   networks:
  #     default:
  #       aliases:
  #         - client.example.org
  #   volumes:
  #     - mnt_home:/home
